<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Batch Generator (Client-side)</title>

  <style>
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:#f6f8fb; margin:36px;
    }
    .card{background:#fff;padding:22px;border-radius:10px;max-width:820px;margin:0 auto;
      box-shadow:0 8px 28px rgba(0,0,0,0.06)}
    h1{margin:0 0 8px}
    .note{color:#555;font-size:14px;margin-bottom:12px}
    label{display:block;margin-top:12px;font-weight:600}
    input[type=file], input[type=text], select{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px}
    button{margin-top:14px;padding:10px 16px;border-radius:8px;border:0;background:#0b74de;color:#fff;font-weight:700;cursor:pointer}
    .alert{display:flex;align-items:flex-start;padding:10px;border-radius:8px;margin-top:12px;font-size:14px}
    .alert.success{background:#eef7ed;color:#0a7d2f}
    .alert.warning{background:#fff7ea;color:#b07d00}
    .alert.danger{background:#fdecea;color:#b00020}
    .alert .icon{margin-right:10px;font-size:18px}
    .small{font-size:13px;color:#666;margin-top:8px}
    #progress{margin-top:12px}
    #progress > div{height:10px;background:#e6eefc;border-radius:6px;overflow:hidden}
    #progressBar{height:100%;width:0%;background:#0b74de}
    pre{background:#f3f4f6;padding:10px;border-radius:6px;white-space:pre-wrap;word-wrap:break-word}
  </style>
</head>
<body>
  <div class="card">
    <h1>QR Batch Generator</h1>
    <p class="note">Upload file Excel (.xls / .xlsx). Script akan baca header pada <strong>baris ke-3</strong> (header=2). Pastikan kolom: <strong>Nama Peserta</strong>, <strong>QR-Code</strong>, <strong>Kelas</strong>.</p>

    <div id="msg"></div>

    <form id="frm">
      <label for="file">File Excel</label>
      <input id="file" type="file" accept=".xls,.xlsx" required />

      <label for="outname">Nama folder output (opsional)</label>
      <input id="outname" type="text" placeholder="QR PTK DARUL MUJAHIDIN" />

      <label for="format">Format kompresi</label>
      <select id="format">
        <option value="zip" selected>ZIP (direkomendasikan)</option>
      </select>

      <button id="start" type="button">Generate & Download</button>
    </form>

    <div id="progress" style="display:none;margin-top:10px">
      <div><div id="progressBar"></div></div>
      <div class="small" id="progressText"></div>
    </div>

    <p class="small">Catatan: proses terjadi di browser — file tidak dikirim ke server. Jika file besar, proses mungkin butuh beberapa detik.</p>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script>
    // Util: safe filename
    function cleanFilename(text){
      if(text === undefined || text === null) return "unnamed";
      return String(text).trim()
        .replace(/[<>:"/\\|?*\u0000-\u001f]/g, '')
        .replace(/\s+/g, ' ')
        .substring(0, 120) || "unnamed";
    }

    // Show message
    function showMessage(type, html){
      const container = document.getElementById('msg');
      container.innerHTML = `
        <div class="alert ${type}">
          <div class="icon">${ type==='danger' ? '❌' : (type==='warning' ? '⚠️' : '✅') }</div>
          <div>${html}</div>
        </div>
      `;
    }

    // Clear message
    function clearMessage(){ document.getElementById('msg').innerHTML = ''; }

    // Progress
    function setProgress(percent, text){
      const p = document.getElementById('progress');
      p.style.display = 'block';
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressText').textContent = text || '';
    }

    async function processFile(file){
      clearMessage();
      setProgress(0, 'Membaca file...');

      // read as ArrayBuffer
      const ab = await file.arrayBuffer();

      let workbook;
      try {
        workbook = XLSX.read(ab, {type: 'array'});
      } catch(err){
        showMessage('danger', `Gagal membaca file Excel: ${err.message || err}. Pastikan file benar (.xls/.xlsx) dan bukan halaman HTML.`);
        setProgress(0, '');
        return;
      }

      // take first sheet
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];

      // get rows as arrays
      const rows = XLSX.utils.sheet_to_json(sheet, {header:1, raw: false, defval: ''});

      // check header row index 2 (baris ke-3)
      const headerRowIndex = 2;
      if(rows.length <= headerRowIndex){
        showMessage('danger', 'File Excel tidak memiliki baris header di baris ke-3. Cek kembali file Anda.');
        setProgress(0, '');
        return;
      }

      const headers = rows[headerRowIndex].map(h => String(h).trim());
      // Find required columns (case-insensitive)
      function findCol(name){
        const idx = headers.findIndex(h => String(h || '').toLowerCase() === name.toLowerCase());
        return idx;
      }

      const namaIdx = findCol('Nama Peserta'.toLowerCase()) !== -1 ? headers.findIndex(h => String(h||'').toLowerCase()==='nama peserta') : findCol('nama peserta');
      const kodeIdx = findCol('QR-Code'.toLowerCase()) !== -1 ? headers.findIndex(h => String(h||'').toLowerCase()==='qr-code') : findCol('qr-code');
      const kelasIdx = findCol('Kelas'.toLowerCase()) !== -1 ? headers.findIndex(h => String(h||'').toLowerCase()==='kelas') : findCol('kelas');

      // robust search: case-insensitive matching using lowercase compare
      const headersLower = headers.map(h => String(h||'').toLowerCase());
      const idxNama = headersLower.indexOf('nama peserta');
      const idxKode = headersLower.indexOf('qr-code');
      const idxKelas = headersLower.indexOf('kelas');

      if(idxNama === -1 || idxKode === -1 || idxKelas === -1){
        // attempt fuzzy: contains substring
        const findContains = term => headersLower.findIndex(h => h.includes(term));
        const altNama = findContains('nama');
        const altKode = findContains('qr');
        const altKelas = findContains('kelas') ;
        if(altNama === -1 || altKode === -1 || altKelas === -1){
          showMessage('danger', `Kolom tidak ditemukan. Pastikan header (baris ke-3) memiliki kolom: Nama Peserta, QR-Code, Kelas.`);
          return;
        } else {
          // use fuzzy indices if full not found
          var useNama = altNama, useKode = altKode, useKelas = altKelas;
        }
      } else {
        var useNama = idxNama, useKode = idxKode, useKelas = idxKelas;
      }

      // Prepare JSZip
      const zip = new JSZip();
      const outRootName = cleanFilename(document.getElementById('outname').value || 'QR PTK DARUL MUJAHIDIN');

      const startDataRow = headerRowIndex + 1; // rows following header
      let totalRows = rows.length - startDataRow;
      if(totalRows <= 0){
        showMessage('warning', 'Tidak ada data setelah baris header (baris ke-3). Pastikan file berisi data.');
        return;
      }

      let processed = 0;
      setProgress(2, `Menyiapkan ${totalRows} baris...`);

      for(let r = startDataRow; r < rows.length; r++){
        const row = rows[r];
        // handle if row shorter; defval used earlier ensures cell exists
        const nama = cleanFilename(row[useNama] || row[useNama]===0 ? row[useNama] : 'unnamed');
        const kode = String(row[useKode] || '').trim();
        const kelas = cleanFilename(row[useKelas] || 'Umum');

        if(!kode || kode === 'undefined') {
          processed++;
          setProgress(Math.round((processed/totalRows)*90), `Memproses ${processed}/${totalRows} (melewati jika kode kosong)...`);
          continue;
        }

        // produce QR data URL (PNG) using qrcode lib
        try {
          // QR options - set small margin and reasonable scale
          const opts = { errorCorrectionLevel: 'M', type: 'image/png', margin: 1, scale: 6 };
          // NOTE: QRCode.toDataURL returns Promise when callback omitted
          const dataUrl = await QRCode.toDataURL(kode, opts);
          // Convert dataURL to binary and add to zip at folder klas
          const base64 = dataUrl.split(',')[1];
          const folderPath = `${outRootName}/${kelas}/`;
          // name file with .png
          const fileName = `${nama}.png`;
          zip.folder(folderPath).file(fileName, base64, {binary:false, base64:true});
        } catch(err){
          console.error('QR gen error', err);
          // add a small text file noting the error instead of PNG
          const folderPath = `${outRootName}/${kelas}/`;
          zip.folder(folderPath).file(`${nama}_ERROR.txt`, `Gagal membuat QR: ${err}`);
        }

        processed++;
        setProgress(Math.round((processed/totalRows)*90), `Memproses ${processed}/${totalRows}...`);
      }

      // finalize zip
      setProgress(92, 'Membuat file ZIP...');
      try {
        const content = await zip.generateAsync({type:"blob"}, progress => {
          // progress.percent available
          setProgress(92 + Math.round(progress.percent/100*8), `Membuat ZIP: ${Math.round(progress.percent)}%`);
        });
        // download
        const zipName = `${outRootName}.zip`;
        saveAs(content, zipName);
        setProgress(100, `Selesai — file ${zipName} siap diunduh.`);
        showMessage('success', `Berhasil membuat ZIP. File akan otomatis diunduh (${zipName}).`);
      } catch(err){
        showMessage('danger', `Gagal membuat ZIP: ${err}`);
        setProgress(0, '');
      }
    }

    // Button handler
    document.getElementById('start').addEventListener('click', async () => {
      const f = document.getElementById('file').files[0];
      if(!f){ showMessage('warning','Silakan pilih file Excel terlebih dahulu.'); return; }
      // simple size guard (optional)
      if(f.size > 50 * 1024 * 1024){ // 50MB
        if(!confirm('File cukup besar (>50MB). Lanjutkan?')) return;
      }
      await processFile(f);
    });

  </script>
</body>
</html>
